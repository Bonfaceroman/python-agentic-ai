"""
AI Content Generator - Flask Web App with Google Gemini
"""

from flask import Flask, render_template, request, jsonify, send_file
import os
import google.generativeai as genai
from datetime import datetime
from dotenv import load_dotenv

# Load environment variables
load_dotenv()

# Configure Gemini API
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    raise Exception("‚ùå Please set GEMINI_API_KEY in your .env file!")

genai.configure(api_key=GEMINI_API_KEY)

# Initialize Flask app
app = Flask(__name__)

# Initialize Gemini model
model = genai.GenerativeModel('gemini-1.5-flash')

# Content generation function
def generate_content(content_type, user_description):
    """Generate content using Google Gemini API"""
    
    prompts = {
        "blog": {
            "system": "You are an expert blog writer who creates engaging, readable content. Write conversationally, use clear structure with headings, keep paragraphs short.",
            "user": f"Write a blog post: {user_description}",
        },
        "twitter": {
            "system": "You are a Twitter/X expert. Create 5 engaging tweets (max 280 chars each). Use 2-3 hashtags. Number them clearly.",
            "user": f"Create Twitter posts: {user_description}",
        },
        "linkedin": {
            "system": "You are a LinkedIn strategist. Create 3-5 professional posts. Share insights, use 1-2 hashtags. Number them clearly.",
            "user": f"Create LinkedIn posts: {user_description}",
        },
        "instagram": {
            "system": "You are an Instagram creator. Create 3-5 captions with 5-8 hashtags. First line must hook readers. Number them clearly.",
            "user": f"Create Instagram captions: {user_description}",
        },
        "facebook": {
            "system": "You are a Facebook content specialist. Create 3-5 engaging posts. Conversational tone, ask questions. Number them clearly.",
            "user": f"Create Facebook posts: {user_description}",
        },
        "email": {
            "system": "You are a professional email writer. Format: Subject, Greeting, Body, Closing, Sign off. Keep under 250 words, professional but warm.",
            "user": f"Write an email: {user_description}",
        },
        "product": {
            "system": "You are a conversion copywriter. Focus on benefits, not features. 150-200 words, address pain points, create desire, strong CTA.",
            "user": f"Write product description: {user_description}",
        }
    }

    prompt_config = prompts.get(content_type, prompts["blog"])
    
    # Combine system and user prompts for Gemini
    full_prompt = f"{prompt_config['system']}\n\n{prompt_config['user']}"
    
    try:
        # Generate content with Gemini
        response = model.generate_content(full_prompt)
        return response.text
    except Exception as e:
        raise Exception(f"Gemini API Error: {str(e)}")

# ROUTES
@app.route('/')
def home():
    return render_template('index.html')

@app.route('/generate', methods=['POST'])
def generate():
    try:
        data = request.json
        content_type = data.get('content_type')
        description = data.get('description')

        if not content_type or not description:
            return jsonify({'error': 'Missing content_type or description'}), 400

        # Generate content using Gemini
        content = generate_content(content_type, description)

        # Save to file
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"{content_type}_{timestamp}.txt"

        if not os.path.exists('generated_content'):
            os.makedirs('generated_content')

        filepath = f"generated_content/{filename}"
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(f"Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"Type: {content_type}\n")
            f.write(f"Description: {description}\n")
            f.write("="*70 + "\n\n")
            f.write(content)

        return jsonify({
            'success': True,
            'content': content,
            'filename': filename
        })

    except Exception as e:
        print(f"Error: {str(e)}")
        return jsonify({'error': str(e)}), 500

@app.route('/download/<filename>')
def download(filename):
    filepath = f"generated_content/{filename}"
    if os.path.exists(filepath):
        return send_file(filepath, as_attachment=True)
    return jsonify({'error': 'File not found'}), 404

if __name__ == '__main__':
    print("\n" + "="*70)
    print("üöÄ AI CONTENT GENERATOR - GOOGLE GEMINI POWERED")
    print("="*70)
    print("\n‚úÖ Server starting...")
    print("üì± Open your browser and go to: http://localhost:5000")
    print("\nüí° Press Ctrl+C to stop the server")
    print("="*70 + "\n")

    app.run(debug=True, host='0.0.0.0', port=5000)
